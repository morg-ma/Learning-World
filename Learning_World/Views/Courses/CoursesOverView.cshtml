@model CoursesOverviewViewModel
@{
    ViewData["Title"] = "CoursesOverView";
}

<h1>Courses Overview</h1>

<hr />
<div class="mb-3">
    <div id="searchForm" class="flex justify-content-center mt-2">
        <div class="nav justify-content-center">
            <input class="form-control d-inline w-50 me-1" type="search" id="searchInput" name="search" value="@Model.Search" placeholder="Search Courses" />
            <button class="btn btn-outline-primary" type="button" onclick="loadCourses()">Search</button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Filter Sidebar -->
    <div class="col-md-2">
        <form id="filterForm" method="get">
            <h5>Level</h5>
            @foreach (var level in new List<string> { "Beginner", "Intermediate", "Advanced" })
            {
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="@level" name="Levels" value="@level" @(Model.Levels.Contains(level) ? "checked" : "")>
                    <label class="form-check-label" for="@level">@level</label>
                </div>
            }

            <h5 class="mt-4">Price</h5>
            @foreach (var price in new List<string> { "Free", "Paid" })
            {
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="@price" name="Prices" value="@price" @(Model.Prices.Contains(price) ? "checked" : "")>
                    <label class="form-check-label" for="@price">@price</label>
                </div>
            }

            <h5 class="mt-4">Ratings</h5>
            @foreach (var rate in new List<string> { "2", "3", "4" })
            {
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="@rate" name="Rates" value="@rate" @(Model.Rates.Contains(rate) ? "checked" : "")>
                    <label class="form-check-label" for="@rate">@rate ⭐ or more</label>
                </div>
            }
        </form>
    </div>

    <div class="col-md-10">
        <!-- Sort by DropDownList -->
        <div class="dropdown ms-4 mt-2" style="width: 150px;">
            <button class="btn btn-light dropdown-toggle w-150" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                Sort by
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton">
                <li><button class="dropdown-item" data-sort="MostPopular">Most Popular</button></li>
                <li><button class="dropdown-item" data-sort="HighestRated">Highest Rated</button></li>
                <li><button class="dropdown-item" data-sort="Newest">Newest</button></li>
            </ul>
        </div>

        <!-- Container for courses -->
        <div id="filteredCourses">
            @await Html.PartialAsync("_CoursesOverviewPartial", Model)
        </div>
    </div>
</div>


<div class="col-md-12">
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item">
                <button class="page-link" onclick="loadCourses(@Model.Page.PageNo - 1)" @(Model.Page.HasPrevPage ? "" : "disabled")>Previous</button>
            </li>
            @for (var i = 1; i <= Model.Page.TotalPages; i++)
            {
                <li class="page-item @(i == Model.Page.PageNo ? "active" : "")">
                    <button class="page-link" onclick="loadCourses(@i)">@i</button>
                </li>
            }
            <li class="page-item">
                <button class="page-link" onclick="loadCourses(@Model.Page.PageNo + 1)" @(Model.Page.HasNextPage ? "" : "disabled")>Next</button>
            </li>
        </ul>
    </nav>
</div>

@section Scripts {
    <script>
        function loadCourses(pageNo = 1) {
            var formData = $('#filterForm').serialize();
            var search = $('#searchInput').val();
            var sortOrder = $('#dropdownMenuButton').data('sort') || 'MostPopular'; // Default to 'MostPopular' if no sort is selected

            $.ajax({
                url: '/Courses/CoursesOverView' + "?sortOrder=" + sortOrder + "&search=" + search + "&pageNo=" + pageNo,
                type: 'GET',
                data: formData,
                success: function (response) {
                    $('#filteredCourses').html(response);
                }
            });
        }

        // Trigger AJAX when any filter or search input is changed
        $('#filterForm input[type="checkbox"]').on('change', function () {
            loadCourses();
        });

        // Trigger sorting when a sorting option is selected
        $('.dropdown-item').on('click', function () {
            var selectedSort = $(this).data('sort');
            $('#dropdownMenuButton').data('sort', selectedSort); // Set the sort order in the button's data attribute
            $('#dropdownMenuButton').text($(this).text().trim()); // Update the dropdown button text
            loadCourses(); // Load the sorted courses
        });

        // Trigger search on pressing 'Enter'
        $('#searchInput').keypress(function (e) {
            if (e.which === 13) {
                loadCourses();
            }
        });
    </script>

}